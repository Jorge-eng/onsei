
#include "fft.h"
#include "hellomath.h"

#include <stdlib.h> //for abs
#include <string.h>
#include <stdint.h>

#define FIX_MPY(DEST,A,B) (DEST) = ((int32_t)(A) * (int32_t)(B))>>15

//#define fix_mpy(A, B) (FIX_MPY(a,a,b))

#define LOG2_N_WAVE     (10)
#define N_WAVE          (1 << LOG2_N_WAVE)        /* dimension of Sinewave[] */

static const uint16_t sin_lut[N_WAVE/4+1] = {
  0, 201, 402, 603, 804, 1005, 1206, 1406,
  1607, 1808, 2009, 2209, 2410, 2610, 2811, 3011,
  3211, 3411, 3611, 3811, 4011, 4210, 4409, 4608,
  4807, 5006, 5205, 5403, 5601, 5799, 5997, 6195,
  6392, 6589, 6786, 6982, 7179, 7375, 7571, 7766,
  7961, 8156, 8351, 8545, 8739, 8932, 9126, 9319,
  9511, 9703, 9895, 10087, 10278, 10469, 10659, 10849,
  11038, 11227, 11416, 11604, 11792, 11980, 12166, 12353,
  12539, 12724, 12909, 13094, 13278, 13462, 13645, 13827,
  14009, 14191, 14372, 14552, 14732, 14911, 15090, 15268,
  15446, 15623, 15799, 15975, 16150, 16325, 16499, 16672,
  16845, 17017, 17189, 17360, 17530, 17699, 17868, 18036,
  18204, 18371, 18537, 18702, 18867, 19031, 19194, 19357,
  19519, 19680, 19840, 20000, 20159, 20317, 20474, 20631,
  20787, 20942, 21096, 21249, 21402, 21554, 21705, 21855,
  22004, 22153, 22301, 22448, 22594, 22739, 22883, 23027,
  23169, 23311, 23452, 23592, 23731, 23869, 24006, 24143,
  24278, 24413, 24546, 24679, 24811, 24942, 25072, 25201,
  25329, 25456, 25582, 25707, 25831, 25954, 26077, 26198,
  26318, 26437, 26556, 26673, 26789, 26905, 27019, 27132,
  27244, 27355, 27466, 27575, 27683, 27790, 27896, 28001,
  28105, 28208, 28309, 28410, 28510, 28608, 28706, 28802,
  28897, 28992, 29085, 29177, 29268, 29358, 29446, 29534,
  29621, 29706, 29790, 29873, 29955, 30036, 30116, 30195,
  30272, 30349, 30424, 30498, 30571, 30643, 30713, 30783,
  30851, 30918, 30984, 31049,
  31113, 31175, 31236, 31297,
  31356, 31413, 31470, 31525, 31580, 31633, 31684, 31735,
  31785, 31833, 31880, 31926, 31970, 32014, 32056, 32097,
  32137, 32176, 32213, 32249, 32284, 32318, 32350, 32382,
  32412, 32441, 32468, 32495, 32520, 32544, 32567, 32588,
  32609, 32628, 32646, 32662, 32678, 32692, 32705, 32717,
  32727, 32736, 32744, 32751, 32757, 32761, 32764, 32766, 32767
};


const static int16_t Ar[513] = {0,0,0,1,1,2,3,4,5,6,8,9,11,13,15,17,20,22,25,28,31,34,37,41,44,48,52,56,60,65,69,74,79,84,89,94,100,105,111,117,123,129,136,142,149,156,163,170,177,185,192,200,208,216,224,233,241,250,259,268,277,286,296,305,315,325,335,345,355,366,376,387,398,409,420,432,443,455,467,479,491,503,516,528,541,554,567,580,593,607,621,634,648,662,677,691,705,720,735,750,765,780,796,811,827,843,859,875,891,908,924,941,958,975,992,1009,1027,1044,1062,1080,1098,1116,1134,1153,1171,1190,1209,1228,1247,1266,1286,1306,1325,1345,1365,1385,1406,1426,1447,1467,1488,1509,1530,1552,1573,1595,1616,1638,1660,1682,1704,1727,1749,1772,1795,1818,1841,1864,1887,1911,1935,1958,1982,2006,2030,2055,2079,2104,2128,2153,2178,2203,2229,2254,2280,2305,2331,2357,2383,2409,2435,2462,2488,2515,2542,2569,2596,2623,2651,2678,2706,2733,2761,2789,2817,2846,2874,2902,2931,2960,2989,3018,3047,3076,3105,3135,3165,3194,3224,3254,3284,3315,3345,3376,3406,3437,3468,3499,3530,3561,3592,3624,3655,3687,3719,3751,3783,3815,3847,3880,3912,3945,3978,4011,4044,4077,4110,4144,4177,4211,4244,4278,4312,4346,4380,4414,4449,4483,4518,4553,4587,4622,4657,4693,4728,4763,4799,4834,4870,4906,4942,4978,5014,5050,5087,5123,5160,5196,5233,5270,5307,5344,5381,5418,5456,5493,5531,5569,5606,5644,5682,5721,5759,5797,5835,5874,5913,5951,5990,6029,6068,6107,6146,6186,6225,6264,6304,6344,6383,6423,6463,6503,6543,6584,6624,6664,6705,6746,6786,6827,6868,6909,6950,6991,7032,7074,7115,7157,7198,7240,7282,7323,7365,7407,7449,7492,7534,7576,7619,7661,7704,7746,7789,7832,7875,7918,7961,8004,8047,8091,8134,8177,8221,8265,8308,8352,8396,8440,8484,8528,8572,8616,8661,8705,8749,8794,8839,8883,8928,8973,9018,9063,9108,9153,9198,9243,9288,9334,9379,9424,9470,9516,9561,9607,9653,9699,9745,9791,9837,9883,9929,9975,10021,10068,10114,10161,10207,10254,10300,10347,10394,10441,10487,10534,10581,10628,10676,10723,10770,10817,10864,10912,10959,11007,11054,11102,11149,11197,11245,11292,11340,11388,11436,11484,11532,11580,11628,11676,11724,11772,11821,11869,11917,11966,12014,12063,12111,12160,12208,12257,12306,12354,12403,12452,12501,12549,12598,12647,12696,12745,12794,12843,12892,12942,12991,13040,13089,13138,13188,13237,13286,13336,13385,13435,13484,13533,13583,13632,13682,13732,13781,13831,13881,13930,13980,14030,14079,14129,14179,14229,14279,14329,14378,14428,14478,14528,14578,14628,14678,14728,14778,14828,14878,14928,14978,15028,15078,15129,15179,15229,15279,15329,15379,15429,15480,15530,15580,15630,15680,15731,15781,15831,15881,15932,15982,16032,16082,16133,16183,16233,16283,16334,16384};

const static int16_t Ai[513] = {0,50,101,151,201,251,302,352,402,452,503,553,603,653,704,754,804,854,904,955,1005,1055,1105,1155,1205,1255,1306,1356,1406,1456,1506,1556,1606,1656,1706,1756,1806,1856,1906,1956,2006,2055,2105,2155,2205,2255,2305,2354,2404,2454,2503,2553,2603,2652,2702,2752,2801,2851,2900,2949,2999,3048,3098,3147,3196,3246,3295,3344,3393,3442,3492,3541,3590,3639,3688,3737,3786,3835,3883,3932,3981,4030,4078,4127,4176,4224,4273,4321,4370,4418,4467,4515,4563,4612,4660,4708,4756,4804,4852,4900,4948,4996,5044,5092,5139,5187,5235,5282,5330,5377,5425,5472,5520,5567,5614,5661,5708,5756,5803,5850,5897,5943,5990,6037,6084,6130,6177,6223,6270,6316,6363,6409,6455,6501,6547,6593,6639,6685,6731,6777,6823,6868,6914,6960,7005,7050,7096,7141,7186,7231,7276,7321,7366,7411,7456,7501,7545,7590,7635,7679,7723,7768,7812,7856,7900,7944,7988,8032,8076,8119,8163,8207,8250,8293,8337,8380,8423,8466,8509,8552,8595,8638,8680,8723,8765,8808,8850,8892,8935,8977,9019,9061,9102,9144,9186,9227,9269,9310,9352,9393,9434,9475,9516,9557,9598,9638,9679,9720,9760,9800,9841,9881,9921,9961,10001,10040,10080,10120,10159,10198,10238,10277,10316,10355,10394,10433,10471,10510,10549,10587,10625,10663,10702,10740,10778,10815,10853,10891,10928,10966,11003,11040,11077,11114,11151,11188,11224,11261,11297,11334,11370,11406,11442,11478,11514,11550,11585,11621,11656,11691,11727,11762,11797,11831,11866,11901,11935,11970,12004,12038,12072,12106,12140,12173,12207,12240,12274,12307,12340,12373,12406,12439,12472,12504,12537,12569,12601,12633,12665,12697,12729,12760,12792,12823,12854,12885,12916,12947,12978,13008,13039,13069,13100,13130,13160,13190,13219,13249,13279,13308,13337,13366,13395,13424,13453,13482,13510,13538,13567,13595,13623,13651,13678,13706,13733,13761,13788,13815,13842,13869,13896,13922,13949,13975,14001,14027,14053,14079,14104,14130,14155,14181,14206,14231,14256,14280,14305,14329,14354,14378,14402,14426,14449,14473,14497,14520,14543,14566,14589,14612,14635,14657,14680,14702,14724,14746,14768,14789,14811,14832,14854,14875,14896,14917,14937,14958,14978,14999,15019,15039,15059,15078,15098,15118,15137,15156,15175,15194,15213,15231,15250,15268,15286,15304,15322,15340,15357,15375,15392,15409,15426,15443,15460,15476,15493,15509,15525,15541,15557,15573,15588,15604,15619,15634,15649,15664,15679,15693,15707,15722,15736,15750,15763,15777,15791,15804,15817,15830,15843,15856,15868,15881,15893,15905,15917,15929,15941,15952,15964,15975,15986,15997,16008,16018,16029,16039,16049,16059,16069,16079,16088,16098,16107,16116,16125,16134,16143,16151,16160,16168,16176,16184,16192,16199,16207,16214,16221,16228,16235,16242,16248,16255,16261,16267,16273,16279,16284,16290,16295,16300,16305,16310,16315,16319,16324,16328,16332,16336,16340,16343,16347,16350,16353,16356,16359,16362,16364,16367,16369,16371,16373,16375,16376,16378,16379,16380,16381,16382,16383,16383,16384,16384,16384};

const static int16_t Br[513] = {32767,32767,32767,32767,32767,32766,32765,32764,32763,32762,32760,32759,32757,32755,32753,32751,32748,32746,32743,32740,32737,32734,32731,32727,32724,32720,32716,32712,32708,32703,32699,32694,32689,32684,32679,32674,32668,32663,32657,32651,32645,32639,32632,32626,32619,32612,32605,32598,32591,32583,32576,32568,32560,32552,32544,32535,32527,32518,32509,32500,32491,32482,32472,32463,32453,32443,32433,32423,32413,32402,32392,32381,32370,32359,32348,32336,32325,32313,32301,32289,32277,32265,32252,32240,32227,32214,32201,32188,32175,32161,32147,32134,32120,32106,32091,32077,32063,32048,32033,32018,32003,31988,31972,31957,31941,31925,31909,31893,31877,31860,31844,31827,31810,31793,31776,31759,31741,31724,31706,31688,31670,31652,31634,31615,31597,31578,31559,31540,31521,31502,31482,31462,31443,31423,31403,31383,31362,31342,31321,31301,31280,31259,31238,31216,31195,31173,31152,31130,31108,31086,31064,31041,31019,30996,30973,30950,30927,30904,30881,30857,30833,30810,30786,30762,30738,30713,30689,30664,30640,30615,30590,30565,30539,30514,30488,30463,30437,30411,30385,30359,30333,30306,30280,30253,30226,30199,30172,30145,30117,30090,30062,30035,30007,29979,29951,29922,29894,29866,29837,29808,29779,29750,29721,29692,29663,29633,29603,29574,29544,29514,29484,29453,29423,29392,29362,29331,29300,29269,29238,29207,29176,29144,29113,29081,29049,29017,28985,28953,28921,28888,28856,28823,28790,28757,28724,28691,28658,28624,28591,28557,28524,28490,28456,28422,28388,28354,28319,28285,28250,28215,28181,28146,28111,28075,28040,28005,27969,27934,27898,27862,27826,27790,27754,27718,27681,27645,27608,27572,27535,27498,27461,27424,27387,27350,27312,27275,27237,27199,27162,27124,27086,27047,27009,26971,26933,26894,26855,26817,26778,26739,26700,26661,26622,26582,26543,26504,26464,26424,26385,26345,26305,26265,26225,26184,26144,26104,26063,26022,25982,25941,25900,25859,25818,25777,25736,25694,25653,25611,25570,25528,25486,25445,25403,25361,25319,25276,25234,25192,25149,25107,25064,25022,24979,24936,24893,24850,24807,24764,24721,24677,24634,24591,24547,24503,24460,24416,24372,24328,24284,24240,24196,24152,24107,24063,24019,23974,23929,23885,23840,23795,23750,23705,23660,23615,23570,23525,23480,23434,23389,23344,23298,23252,23207,23161,23115,23069,23023,22977,22931,22885,22839,22793,22747,22700,22654,22607,22561,22514,22468,22421,22374,22327,22281,22234,22187,22140,22092,22045,21998,21951,21904,21856,21809,21761,21714,21666,21619,21571,21523,21476,21428,21380,21332,21284,21236,21188,21140,21092,21044,20996,20947,20899,20851,20802,20754,20705,20657,20608,20560,20511,20462,20414,20365,20316,20267,20219,20170,20121,20072,20023,19974,19925,19876,19826,19777,19728,19679,19630,19580,19531,19482,19432,19383,19333,19284,19235,19185,19136,19086,19036,18987,18937,18887,18838,18788,18738,18689,18639,18589,18539,18489,18439,18390,18340,18290,18240,18190,18140,18090,18040,17990,17940,17890,17840,17790,17740,17690,17639,17589,17539,17489,17439,17389,17339,17288,17238,17188,17138,17088,17037,16987,16937,16887,16836,16786,16736,16686,16635,16585,16535,16485,16434,16384};

const static int16_t Bi[513] = {0,-50,-101,-151,-201,-251,-302,-352,-402,-452,-503,-553,-603,-653,-704,-754,-804,-854,-904,-955,-1005,-1055,-1105,-1155,-1205,-1255,-1306,-1356,-1406,-1456,-1506,-1556,-1606,-1656,-1706,-1756,-1806,-1856,-1906,-1956,-2006,-2055,-2105,-2155,-2205,-2255,-2305,-2354,-2404,-2454,-2503,-2553,-2603,-2652,-2702,-2752,-2801,-2851,-2900,-2949,-2999,-3048,-3098,-3147,-3196,-3246,-3295,-3344,-3393,-3442,-3492,-3541,-3590,-3639,-3688,-3737,-3786,-3835,-3883,-3932,-3981,-4030,-4078,-4127,-4176,-4224,-4273,-4321,-4370,-4418,-4467,-4515,-4563,-4612,-4660,-4708,-4756,-4804,-4852,-4900,-4948,-4996,-5044,-5092,-5139,-5187,-5235,-5282,-5330,-5377,-5425,-5472,-5520,-5567,-5614,-5661,-5708,-5756,-5803,-5850,-5897,-5943,-5990,-6037,-6084,-6130,-6177,-6223,-6270,-6316,-6363,-6409,-6455,-6501,-6547,-6593,-6639,-6685,-6731,-6777,-6823,-6868,-6914,-6960,-7005,-7050,-7096,-7141,-7186,-7231,-7276,-7321,-7366,-7411,-7456,-7501,-7545,-7590,-7635,-7679,-7723,-7768,-7812,-7856,-7900,-7944,-7988,-8032,-8076,-8119,-8163,-8207,-8250,-8293,-8337,-8380,-8423,-8466,-8509,-8552,-8595,-8638,-8680,-8723,-8765,-8808,-8850,-8892,-8935,-8977,-9019,-9061,-9102,-9144,-9186,-9227,-9269,-9310,-9352,-9393,-9434,-9475,-9516,-9557,-9598,-9638,-9679,-9720,-9760,-9800,-9841,-9881,-9921,-9961,-10001,-10040,-10080,-10120,-10159,-10198,-10238,-10277,-10316,-10355,-10394,-10433,-10471,-10510,-10549,-10587,-10625,-10663,-10702,-10740,-10778,-10815,-10853,-10891,-10928,-10966,-11003,-11040,-11077,-11114,-11151,-11188,-11224,-11261,-11297,-11334,-11370,-11406,-11442,-11478,-11514,-11550,-11585,-11621,-11656,-11691,-11727,-11762,-11797,-11831,-11866,-11901,-11935,-11970,-12004,-12038,-12072,-12106,-12140,-12173,-12207,-12240,-12274,-12307,-12340,-12373,-12406,-12439,-12472,-12504,-12537,-12569,-12601,-12633,-12665,-12697,-12729,-12760,-12792,-12823,-12854,-12885,-12916,-12947,-12978,-13008,-13039,-13069,-13100,-13130,-13160,-13190,-13219,-13249,-13279,-13308,-13337,-13366,-13395,-13424,-13453,-13482,-13510,-13538,-13567,-13595,-13623,-13651,-13678,-13706,-13733,-13761,-13788,-13815,-13842,-13869,-13896,-13922,-13949,-13975,-14001,-14027,-14053,-14079,-14104,-14130,-14155,-14181,-14206,-14231,-14256,-14280,-14305,-14329,-14354,-14378,-14402,-14426,-14449,-14473,-14497,-14520,-14543,-14566,-14589,-14612,-14635,-14657,-14680,-14702,-14724,-14746,-14768,-14789,-14811,-14832,-14854,-14875,-14896,-14917,-14937,-14958,-14978,-14999,-15019,-15039,-15059,-15078,-15098,-15118,-15137,-15156,-15175,-15194,-15213,-15231,-15250,-15268,-15286,-15304,-15322,-15340,-15357,-15375,-15392,-15409,-15426,-15443,-15460,-15476,-15493,-15509,-15525,-15541,-15557,-15573,-15588,-15604,-15619,-15634,-15649,-15664,-15679,-15693,-15707,-15722,-15736,-15750,-15763,-15777,-15791,-15804,-15817,-15830,-15843,-15856,-15868,-15881,-15893,-15905,-15917,-15929,-15941,-15952,-15964,-15975,-15986,-15997,-16008,-16018,-16029,-16039,-16049,-16059,-16069,-16079,-16088,-16098,-16107,-16116,-16125,-16134,-16143,-16151,-16160,-16168,-16176,-16184,-16192,-16199,-16207,-16214,-16221,-16228,-16235,-16242,-16248,-16255,-16261,-16267,-16273,-16279,-16284,-16290,-16295,-16300,-16305,-16310,-16315,-16319,-16324,-16328,-16332,-16336,-16340,-16343,-16347,-16350,-16353,-16356,-16359,-16362,-16364,-16367,-16369,-16371,-16373,-16375,-16376,-16378,-16379,-16380,-16381,-16382,-16383,-16383,-16384,-16384,-16384};



uint8_t bitlog(uint32_t n) {
    int16_t b;
    
    // shorten computation for small numbers
    if(n <= 8)
        return (int16_t)(2 * n);
    
    // find the highest non-zero bit
    b=31;
    while((b > 2) && ((int32_t)n > 0))
    {
        --b;
        n <<= 1;
    }
    n &= 0x70000000;
    n >>= 28; // keep top 4 bits, of course we're only using 3 of those
    
    b = (int16_t)n + 8 * (b - 1);
    return (uint8_t) b;
}

uint32_t bitexp(uint16_t n) {
    uint16_t b = n/8;
    uint32_t retval;
    
    // make sure no overflow
    if(n > 247)
        return 0xf0000000;
    
    // shorten computation for small numbers
    if(n <= 16)
        return (uint32_t)(n / 2);
    
    retval = n & 7;
    retval |= 8;
    
    return (retval << (b - 2));
}

short fxd_sin( uint16_t x ) {
	x &= 0x3FF;
	if( x > 3*N_WAVE/4 ) {
		return -sin_lut[N_WAVE - x];
	}
	if( x > N_WAVE/2 ) {
		return -sin_lut[x - N_WAVE/2];
	}
	if( x > N_WAVE/4 ) {
		return sin_lut[N_WAVE/2 - x];
	}
	if( x <= N_WAVE/4 ) {
		return sin_lut[x];
	}
	return 0;
}


#if 0
/*
  fix_mpy() - short-point multiplication
*/
inline static short fix_mpy(short a, short b)
{
  FIX_MPY(a, a, b);
  return a;
}
#endif

int fft(int16_t fr[], int16_t fi[], int32_t m)
{
    int32_t mr, nn, i, j, l, k, istep, n;
    int16_t  wr, wi;

    
    n = 1 << m;
    
    if (n > N_WAVE)
        return -1;
    
    mr = 0;
    nn = n - 1;
    
    /* decimation in time - re-order data */
    for (m = 1; m <= nn; ++m) {
        short tmp;
        l = n;
        do {
            l >>= 1;
        } while (mr + l > nn);
        mr = (mr & (l - 1)) + l;
        
        if (mr <= m)
            continue;
        
        //swap
        tmp = fr[m];
        fr[m] = fr[mr];
        fr[mr] = tmp;
        
        //swap
        tmp = fi[m];
        fi[m] = fi[mr];
        fi[mr] = tmp;
    }
    
    l = 1;
    k = LOG2_N_WAVE - 1;
    while (l < n) {
        /* short scaling, for proper normalization -
         there will be log2(n) passes, so this
         results in an overall factor of 1/n,
         distributed to maximize arithmetic accuracy. */
        istep = l << 1;
        for (m = 0; m < l; ++m) {
            j = m << k;
            /* 0 <= j < N_WAVE/2 */
            wr = fxd_sin(j + N_WAVE / 4);
            wi = -fxd_sin(j);
            
            for (i = m; i < n; i += istep) {
                int32_t tr,ti,qr, qi;

                j = i + l;
                
                //tr = fix_mpy(wr, fr[j]) - fix_mpy(wi, fi[j]);
                tr = (int32_t)wr * (int32_t)fr[j] - (int32_t)wi * (int32_t)fi[j];
                tr >>= 1;
                
                //ti = fix_mpy(wr, fi[j]) + fix_mpy(wi, fr[j]);
                ti = (int32_t)wr * (int32_t)fi[j] + (int32_t)wi*(int32_t)fr[j];
                ti >>= 1;
                
                qr = fr[i] << 14;
                qi = fi[i] << 14;
                
                fr[j] = (qr - tr) >> 15;
                fi[j] = (qi - ti) >> 15;
                fr[i] = (qr + tr) >> 15;
                fi[i] = (qi + ti) >> 15;
            }
        }
        --k;
        l = istep;
    }
    return 0;
}
//x is length 2^m
//fr and fi are length 2^(m-1) + 1

int fftr(const int16_t x[], int16_t fr[],int16_t fi[],int32_t m) {
    int16_t tempvec[(1 << 9) + 1];
    uint32_t i,j;
    uint32_t N = 1 << m;
    uint32_t step = 1 << (10 - m);
    int32_t temp32;
    
    if (m > 10) {
        return -1;
    }
    
    /*
    for (i = 0; i < N; i++) {
        printf("%d,",x[i]);
    }
    printf("\n\n");
    */
    
    memset (fi,0,sizeof(int16_t)* N/2);
    memset (fr,0,sizeof(int16_t)* N/2);
    
    for (i = 0; i < N/2; i++) {
        fr[i] = x[2*i];
        fi[i] = x[2*i + 1];
    }
    
    fft(fr,fi,m-1);
    
    fr[N/2] = fr[0];
    fi[N/2] = fi[0];
    //G = A * z + B * np.conj(z[::-1])
    for (i = 0,j = 0; i <= N/2; i++, j += step) {
        temp32 = (Ar[j] * fr[i]) >> 1;
        temp32 += (Br[j] * fr[N/2 - i]) >> 1;
        tempvec[i] = temp32 >> 15;
    }
    
    memcpy(fr,tempvec,sizeof(int16_t) * N/2);
    
    for (i = 0,j = 0; i <= N/2; i++, j += step) {
        temp32 = (Ai[j] * fi[i]) >> 1;
        temp32 -= (Bi[j] * fi[N/2 - i]) >> 1;
        tempvec[i] = temp32 >> 15;
    }
    
    memcpy(fi,tempvec,sizeof(int16_t) * N/2);

    return 0;
    // z is fr[i] + j*fi[i]
    
}

/*
int fftr(int16_t f[], int32_t m)
{
    int32_t i, N = 1<<(m-1);
    int16_t tt, *fr=f, *fi=&f[N];

    for (i=1; i<N; i+=2) {
        tt = f[N+i-1];
        f[N+i-1] = f[i];
        f[i] = tt;
    }
    return fft(fi, fr, m-1);
}
 */

//requires 2N memory... for now
//ndct can be no greater than 8 (ie. length 256)
//so fr should be length (2^(ndct + 1))
void dct(int16_t fr[],int16_t fi[],const int16_t ndct) {
    uint32_t i,k;
    int16_t sine,cosine;
    uint16_t stheta;
    uint16_t ctheta;
    static const uint16_t wavemask = (N_WAVE/4) - 1;
    const uint32_t n = (1 << ndct);
    const int8_t step2n = LOG2_N_WAVE - ndct - 2;
    const uint16_t step = 1 << step2n;
    int32_t temp32;
    memset(fi,0,2*n*sizeof(int16_t));
    //mirror mirror
    for (i = n; i < 2*n; i++) {
        k = 2*n - i - 1;
        fr[i] = fr[k];
    }
    
    fft(fr,fi,ndct + 1);
    
    k = 0;
    for (i = 0; i  < n; i++) {
        //go from 0 to pi/2
        //so sin will go from 0 --> 1
        //cos will go from 1 --> 0
        
        if (k > N_WAVE / 4) {
            stheta = (N_WAVE/2 - k) & wavemask;
            ctheta = k & wavemask;
            
            sine = sin_lut[stheta];
            cosine = -sin_lut[ctheta];
        }
        else {
            stheta = k;
            ctheta = k == 0 ? N_WAVE/4 : (N_WAVE/2 - k) & wavemask;
            
            sine = sin_lut[stheta];
            cosine = sin_lut[ctheta];
        }
        
        temp32 = (int32_t)fr[i] * (int32_t)cosine;
        temp32 -= (int32_t)fi[i] * (int32_t)sine;
        temp32 >>= 15;
        fr[i] = (int16_t)temp32;
        k += step;
    }
    
}

void fix_window(int16_t fr[], int32_t n)
{
  int i, j, k;

  j = N_WAVE / n;
  n >>= 1;
  for (i = 0, k = N_WAVE / 4; i < n; ++i, k += j)
    FIX_MPY(fr[i], fr[i], 16384 - (fxd_sin(k) >> 1));
  n <<= 1;
  for (k -= j; i < n; ++i, k -= j)
    FIX_MPY(fr[i], fr[i], 16384 - (fxd_sin(k) >> 1));
}


void abs_fft(uint16_t psd[], const int16_t fr[],const int16_t fi[],const int16_t len)
{
    int i;
    for (i=0; i < len ; ++i) {
		psd[i] = abs(fr[i]) + abs(fi[i]);
    }
}

/* call this post-fft  */
void updateoctogram(const int16_t fr[],const int16_t fi[]) {

}

// b - size of the bin in the fft in hz
// ergo, b = Fs / 2 / (n/2) or if you prefer, Nyquist freq divided by half of the FFT
// n is the PSD size (nfft / 2)
// f is both input and output
// f as input is the PSD bin, and is always positive
// f as output is the mel bins
void logpsdmel(int16_t * logTotalEnergy,int16_t psd[],const int16_t fr[],const int16_t fi[],uint8_t log2scaleOfRawSignal,uint16_t min_energy) {
    uint16_t i;
    uint16_t ufr;
    uint16_t ufi;
    uint64_t utemp64;
    uint64_t non_weighted_energy;
	uint64_t accumulator64 = 0;
	int32_t temp32;
	static const uint8_t spacings[32] = {1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
			1, 1, 1, 2, 3, 3, 4, 4, 5, 5, 6, 7, 8, 10, 11, 13, 14, 15 };

	static const int16_t binaveragingcoeff[18] = { 0, 0, -1024, -1623, -2048,
			-2378, -2647, -2875, -3072, -3246, -3402, -3542, -3671, -3789,
			-3899, -4001, -4096, -4186 };

	const static uint16_t a_weight_q10[128] = { 0, 0, 100, 150, 263, 379, 489,
			510, 725, 763, 823, 859, 896, 934, 963, 994, 1024, 1054, 1085, 1093,
			1101, 1110, 1123, 1136, 1149, 1152, 1156, 1159, 1162, 1166, 1169,
			1172, 1176, 1166, 1170, 1174, 1178, 1182, 1184, 1185, 1187, 1188,
			1189, 1185, 1180, 1176, 1171, 1167, 1162, 1162, 1162, 1162, 1162,
			1162, 1162, 1162, 1161, 1159, 1157, 1156, 1154, 1152, 1151, 1149,
			1146, 1142, 1139, 1136, 1133, 1129, 1126, 1123, 1120, 1116, 1112,
			1107, 1103, 1098, 1094, 1089, 1085, 1081, 1076, 1072, 1067, 1063,
			1059, 1054, 1050, 1046, 1042, 1037, 1033, 1029, 1025, 1021, 1016,
			1012, 1012, 1009, 1005, 1002, 998, 995, 991, 987, 984, 981, 977,
			974, 970, 967, 963, 959, 956, 952, 948, 945, 941, 937, 934, 930,
			927, 923, 920, 916, 913, 913 };

	uint16_t idx, ifft, iend;

	accumulator64 = 0;
    

    ifft = 1;
    for (idx = 0; idx < 32; idx++) {
       // assert(idx-1 <= 31);
        iend = spacings[idx];
        utemp64 = 0;
        non_weighted_energy = 0;

        for (i = 0; i < iend; i++) {
        	uint64_t a = 0;
          //  assert(ifft < 128);
            ufr = abs(fr[ifft]);
            ufi = abs(fi[ifft]);
            
            a += (uint32_t)ufr*(uint32_t)ufr;
            a += (uint32_t)ufi*(uint32_t)ufi;

            utemp64 += a * a_weight_q10[ifft] >> 10;
            non_weighted_energy += a;
            ifft++;
        }

        temp32 = FixedPointLog2Q10(non_weighted_energy + min_energy) + binaveragingcoeff[iend] - log2scaleOfRawSignal*1024;
        
        if (temp32 > INT16_MAX) {
            temp32 = INT16_MAX;
        }
        
        if (temp32 < INT16_MIN) {
            temp32 = INT16_MIN;
        }
        
        psd[idx] = temp32;
        
        utemp64 = accumulator64 + utemp64;
        if (utemp64 < accumulator64) {
            accumulator64 = 0xFFFFFFFFFFFFFFFF;
        }
        else {
            accumulator64 = utemp64;
        }
    }
    
    temp32 =  FixedPointLog2Q10(accumulator64) - log2scaleOfRawSignal*1024;

    if (temp32 > INT16_MAX) {
    	temp32 = INT16_MAX;
    }
    
    *logTotalEnergy = (int16_t)temp32;


}



#if 0

void freq_energy_bins(int16_t logbinpower[],const int16_t fr[],const int16_t fi[],uint8_t log2scaleOfRawSignal) {
	
    // in Hz
    static const uint16_t k_bin_start = 4;
    static const uint16_t k_bin_width_hz = EXPECTED_AUDIO_SAMPLE_RATE_HZ / AUDIO_FFT_SIZE;
    static const uint16_t k_fundamental_width = 800 / k_bin_width_hz; //800 hz
    
    static const uint16_t k_width_indices[NUM_FREQ_ENERGY_BINS] = {1,2,3,4,5,6}; // k_fundamental_width * the index gets you the top of the bin.
	static const int16_t k_log2_normalization[NUM_FREQ_ENERGY_BINS] = {2,2,2,2,2,2};
    uint16_t iBin;
    uint16_t iBinEdge;
    uint16_t nextBinEdge;

    uint64_t accumulator64;
    int32_t temp32;
    uint64_t utemp64;
    
    uint16_t ufr;
    uint16_t ufi;
    int16_t scale;


    
	accumulator64 = 0;
    iBinEdge = 0;
    nextBinEdge = k_width_indices[0]*k_fundamental_width - 1;
    iBin = k_bin_start;

    /* skip dc, start at 1 */
    while(1) {
        //take PSD here
        ufr = abs(fr[iBin]);
        ufi = abs(fi[iBin]);
        
        utemp64 = 0;
        utemp64 += (uint32_t)ufr*(uint32_t)ufr;
        utemp64 += (uint32_t)ufi*(uint32_t)ufi;

        if (accumulator64 + utemp64 < accumulator64) {
            accumulator64 = 0xFFFFFFFFFFFFFFFF;
        }
        else {
            accumulator64 += utemp64;
        }
        
        
		if(iBin == nextBinEdge) {
            //deal with different bin widths and original signal scaling at the same time
            scale = -2*log2scaleOfRawSignal + k_log2_normalization[iBinEdge];
            
            temp32 = FixedPointLog2Q10(accumulator64);
            temp32 += scale*(1<<10);
            
            if (temp32 > INT16_MAX) {
                temp32 = INT16_MAX;
            }
            
            if (temp32 < INT16_MIN) {
                temp32 = INT16_MIN;
            }
            
            logbinpower[iBinEdge]  =  (int16_t)temp32;


            /// prepare for next iterator ///
    
            accumulator64 = 0;

            iBinEdge++;
            
            if (iBinEdge >= sizeof(k_width_indices) / sizeof(k_width_indices[0]) ) {
                break;
            }
            
            nextBinEdge = k_width_indices[iBinEdge]*k_fundamental_width -  1;

		}
        
        iBin++;
	}
}
#endif

#if 0
void norm(short f[], int n) {
    int i;
	unsigned long long m=0;

    for (i=1; i<n; ++i) {
		m += (long long)f[i]*f[i];
    }
	if( m > (1ll<<31) )
		return;
	m = fxd_sqrt( m );
	for (i=0; i<n; ++i) {
		f[i] = 32768 / m * f[i];
    }
}


const short loud_amp[] = {794,704,625,554,491,436,387,343,304,270,239,212,188,167,148,131,116,103,92,81,72,64,57,50,45,40,35,31,28,24,22,19,17,15,13,10,0};

short power_to_dB(short pwr)
{
  short i=sizeof(loud_amp)/sizeof(loud_amp[0]);

  while( pwr > loud_amp[i] && i > -1 ) { --i; }

  return sizeof(loud_amp)/sizeof(loud_amp[0]) - i;
}
#endif
